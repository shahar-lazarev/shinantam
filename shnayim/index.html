<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shnayim Mikrah</title>
  <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
  <style>
    @font-face {
      font-family: "SBL Hebrew";
      src: url("../fonts/SBL_Hbrw.ttf") format("truetype");
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --primary-color: #1a202c;
      --accent-color: #2b6cb0;
      --bg-color: #f7fafc;
      --text-color: #2d3748;
      --border-radius: 12px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }

    .bsd {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 1rem;
      font-weight: bold;
      color: #4b5668;
      z-index: 1000;
      background: var(--bg-color);
      padding: 4px 8px;
      border-radius: var(--border-radius);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
    }

    .dropdown-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
      flex: 1;
      min-width: 150px;
    }

    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #cbd5e0;
      border-radius: var(--border-radius);
      margin-top: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    select:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(43, 108, 176, 0.3);
    }

    .text-display {
      direction: rtl;
      margin-top: 20px;
      padding: 20px;
      background-color: white;
      border: 1px solid #cbd5e0;
      border-radius: var(--border-radius);
      line-height: 1.4;
      font-family: 'SBL Hebrew', 'David Libre', 'Times New Roman', serif;
      white-space: pre-wrap;
      font-size: 1.8rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .copy-button {
      /* display: flex; */
      display: none; /* hide for now */
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s, transform 0.2s;
    }

    .copy-button:hover {
      background-color: #2c5282;
    }

    .copy-button:active {
      transform: scale(0.97);
    }

    footer {
      margin-top: 40px;
      text-align: center;
      font-size: 0.9rem;
      color: #718096;
    }

    @media screen and (max-width: 600px) {
      body {
        padding: 15px 20px;
        max-width: 100%;
      }

      .dropdown-container {
        flex-direction: column;
      }

      .text-display {
        font-size: 1.6rem;
      }

      .bsd {
        font-size: 0.85rem;
        top: 10px;
        right: 10px;
      }
    }

    .rashi-container {
      background: #f3fafe;
      border-radius: var(--border-radius);
      margin: 1rem 0;
      padding: 0;
      overflow: hidden;
    }

    /* Header bar ABOVE the Hebrew/English */
    .rashi-header {
      padding: 10px 15px;
      cursor: pointer;
      
      /* match Hebrew text color/style */
      font-size: 1.3rem;
      color: #222;

      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0;

      /* subtle divider like part of the same box */
      border-bottom: 1px solid rgba(0,0,0,0.1);
      background: #f3fafe;  /* same background as old container */
    }

    .rashi-header:hover {
      background: #e1f0fb;
    }

    /* keeps arrow + buttons grouped tightly */
    .rashi-controls {
      margin-inline-start: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Arrow */
    .rashi-arrow {
      transition: transform 0.2s ease;
      font-size: 1rem;
      opacity: 0.7;
      margin-right: 10px;
      margin-top: 5px;
    }

    .rashi-arrow.rotated {
      transform: rotate(90deg);
    }

    .rashi-action-btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #2b6cb0;
      background: #2b6cb0;
      color: white;
      font-size: 0.7rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }

    .rashi-action-btn:hover {
      background: #2c5282;
    }

    .rashi-action-btn:active {
      transform: scale(0.97);
    }

    /* Collapsible body: THIS preserves your side-by-side layout */
    .rashi-body {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;

      padding: 10px 15px;

      transition: max-height 0.25s ease, opacity 0.25s ease;
    }

    .rashi-body.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0 15px;
      overflow: hidden;
    }

    /* Your original Hebrew Rashi */
    .rashi-he {
      flex: 1;
      direction: rtl;
      text-align: right;
      font-size: 1.4rem;
      line-height: 1.6;
      color: #222;
    }

    /* Your original English Rashi */
    .rashi-en {
      flex: 1.6;
      direction: ltr;
      text-align: left;
      font-size: 1.1rem;
      line-height: 1.6;
      color: #333;
    }
    #progressBar {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      width: 0%;
      background: var(--accent-color);
      z-index: 2000;
      transition: width 0.15s ease-out;
    }

    @media screen and (max-width: 700px) {
      .rashi-body {
        flex-direction: column;   /* stack HE + EN */
      }
      .rashi-he, .rashi-en {
        text-align: center;
      }
    }

  </style>
</head>
<body>
  <div id="progressBar"></div>
  <div class="bsd">×‘×¡×´×“</div>
  <h1>Shnayim Mikrah</h1>

  <div class="dropdown-container">
    <label>Sefer:
      <select id="seferSelect"></select>
    </label>
    <label>Parasha:
      <select id="parashaSelect"></select>
    </label>
    <label>Aliyah:
      <select id="aliyahSelect"></select>
    </label>
  </div>

  <button class="copy-button" onclick="copyText(this)">
    <span class="copy-icon">ðŸ“‹</span> Copy Text
  </button>

  <div id="textDisplay" class="text-display"></div>

  <footer>
    Text provided by <a href="https://www.sefaria.org" target="_blank">Sefaria</a> â€¢ Parasha data by <a href="https://www.hebcal.com" target="_blank">Hebcal</a>
  </footer>
  <footer>Â© 2026 Shinantam</footer>

  <script>
    HEBREW_MAP = {
      "Bereshit": "×‘×¨××©×™×ª",
      "Noach": "× ×—",
      "Lech-Lecha": "×œ×š ×œ×š",
      "Vayera": "×•×™×¨×",
      "Chayei Sara": "×—×™×™ ×©×¨×”",
      "Toldot": "×ª×•×œ×“×•×ª",
      "Vayetzei": "×•×™×¦×",
      "Vayishlach": "×•×™×©×œ×—",
      "Vayeshev": "×•×™×©×‘",
      "Miketz": "×ž×§×¥",
      "Vayigash": "×•×™×’×©",
      "Vayechi": "×•×™×—×™",
      "Shemot": "×©×ž×•×ª",
      "Vaera": "×•××¨×",
      "Bo": "×‘×",
      "Beshalach": "×‘×©×œ×—",
      "Yitro": "×™×ª×¨×•",
      "Mishpatim": "×ž×©×¤×˜×™×",
      "Terumah": "×ª×¨×•×ž×”",
      "Tetzaveh": "×ª×¦×•×”",
      "Ki Tisa": "×›×™ ×ª×©×",
      "Vayakhel": "×•×™×§×”×œ",
      "Pekudei": "×¤×§×•×“×™",
      "Vayikra": "×•×™×§×¨×",
      "Tzav": "×¦×•×”",
      "Shemini": "×©×ž×™× ×™",
      "Tazria": "×ª×–×¨×™×¢",
      "Metzora": "×ž×¦×•×¨×¢",
      "Achrei Mot": "××—×¨×™ ×ž×•×ª",
      "Kedoshim": "×§×“×•×©×™×",
      "Emor": "××ž×•×¨",
      "Behar": "×‘×”×¨",
      "Bechukotai": "×‘×—×§×•×ª×™",
      "Bamidbar": "×‘×ž×“×‘×¨",
      "Nasso": "× ×©×",
      "Beha'alotcha": "×‘×”×¢×œ×•×ª×š",
      "Sh'lach": "×©×œ×—",
      "Korach": "×§×•×¨×—",
      "Chukat": "×—×•×§×ª",
      "Balak": "×‘×œ×§",
      "Pinchas": "×¤×™× ×—×¡",
      "Matot": "×ž×˜×•×ª",
      "Masei": "×ž×¡×¢×™",
      "Devarim": "×“×‘×¨×™×",
      "Vaetchanan": "×•××ª×—× ×Ÿ",
      "Eikev": "×¢×§×‘",
      "Re'eh": "×¨××”",
      "Shoftim": "×©×•×¤×˜×™×",
      "Ki Teitzei": "×›×™ ×ª×¦×",
      "Ki Tavo": "×›×™ ×ª×‘×•×",
      "Nitzavim": "× ×™×¦×‘×™×",
      "Vayeilech": "×•×™×œ×š",
      "Ha'azinu": "×”××–×™× ×•",
      "V'Zot HaBerachah": "×•×–××ª ×”×‘×¨×›×”",
      "VZot HaBerachah": "×•×–××ª ×”×‘×¨×›×”",

      // Combined parashot
      "Vayakhel-Pekudei": "×•×™×§×”×œ-×¤×§×•×“×™",
      "Tazria-Metzora": "×ª×–×¨×™×¢-×ž×¦×•×¨×¢",
      "Achrei Mot-Kedoshim": "××—×¨×™ ×ž×•×ª-×§×“×•×©×™×",
      "Behar-Bechukotai": "×‘×”×¨-×‘×—×§×•×ª×™",
      "Chukat-Balak": "×—×§×ª-×‘×œ×§",
      "Matot-Masei": "×ž×˜×•×ª-×ž×¡×¢×™",
      "Nitzavim-Vayeilech": "× ×™×¦×‘×™×-×•×™×œ×š",

      // Book names
      "Bereshit,": "×‘×¨××©×™×ª,",
      "Shemot,": "×©×ž×•×ª,",
      "Vayikra,": "×•×™×§×¨×,",
      "Bamidbar,": "×‘×ž×“×‘×¨,",
      "Devarim,": "×“×‘×¨×™×,",

      // Aliyah and Maftir
      "Aliyah": "×¢×œ×™×™×”",
      "Maftir": "×ž×¤×˜×™×¨",
    }

    window.addEventListener("scroll", () => {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = (scrollTop / docHeight) * 100;
      document.getElementById("progressBar").style.width = progress + "%";
    });

    const aliyotURL = 'https://raw.githubusercontent.com/shahar-lazarev/shinantam/refs/heads/main/shnayim/Aliyot.txt';
    let aliyotMap = {};

    const STORAGE_KEYS = {
      PARASHA: "shnayim_last_parasha",
      ALIYAH: "shnayim_current_aliyah"
    };

    function saveProgress(parasha, aliyah) {
      localStorage.setItem(STORAGE_KEYS.PARASHA, parasha);
      localStorage.setItem(STORAGE_KEYS.ALIYAH, aliyah);
    }

    function loadProgress() {
      return {
        lastParasha: localStorage.getItem(STORAGE_KEYS.PARASHA),
        currentAliyah: localStorage.getItem(STORAGE_KEYS.ALIYAH),
      };
    }

    async function loadData() {
      try {
        const resp = await fetch(aliyotURL);
        const text = await resp.text();
        parseAliyot(text);

        const currentParasha = await getCurrentParasha();
        const progress = loadProgress();

        populateSeferDropdown(currentParasha);

        // Decide which aliyah to load
        setTimeout(() => {
          const parashaSelect = document.getElementById("parashaSelect");
          const aliyahSelect = document.getElementById("aliyahSelect");

          const isNewParasha =
            !progress.lastParasha || progress.lastParasha !== currentParasha;

          if (isNewParasha) {
            aliyahSelect.value = "Aliyah 1";
            saveProgress(currentParasha, "Aliyah 1");
          } else if (progress.currentAliyah) {
            aliyahSelect.value = progress.currentAliyah;
          }
          displayAliyahText();
        }, 0);

      } catch (err) {
        console.error("Error loading Aliyot:", err);
      }
    }

    function parseAliyot(text) {
      const lines = text.split('\n');
      let shortParasha = '';
      let currentParasha = '';
      for (const line of lines) {
        if (!line.trim()) continue;
        if (!line.startsWith('Aliyah') && !line.startsWith('Maftir')) {
          shortParasha = line.split(',')[0];
          currentParasha = line.trim();
          aliyotMap[shortParasha] = {};
        } else {          
          const [aliyahName, range] = line.split(',');
          if (shortParasha && range) {
            aliyotMap[shortParasha][aliyahName.trim()] = range.trim();
          }
        }
      }
      
    }

    async function getCurrentParasha() {
      const url = 'https://www.hebcal.com/shabbat?cfg=json&geonameid=3448439&M=on';
      const resp = await fetch(url);
      const data = await resp.json();
      const item = data.items.find(it => it.category === 'parashat');
      if (!item || !item.title) return null;
      return item.title.replace('Parashat ', '').trim();
    }

    function populateSeferDropdown(preferredParasha) {
      const seferSet = new Set();
      for (let parasha of Object.keys(aliyotMap)) {
        const aliyot = aliyotMap[parasha];
        const firstRange = Object.values(aliyot)[0];
        if (firstRange) {
          const sefer = firstRange.split(' ')[0];
          seferSet.add(sefer);
        }
      }
      const seferSelect = document.getElementById('seferSelect');
      seferSelect.innerHTML = [...seferSet].map(s => `<option value="${s}">${s}</option>`).join('');

      if (preferredParasha && aliyotMap[preferredParasha]) {
        const firstRange = Object.values(aliyotMap[preferredParasha])[0];
        const sefer = firstRange.split(' ')[0];
        seferSelect.value = sefer;
      }

      seferSelect.addEventListener('change', () => {
        populateParashaDropdown();
        displayAliyahText();
      });
      populateParashaDropdown(preferredParasha);
    }

    function populateParashaDropdown(preferredParasha) {
      const sefer = document.getElementById('seferSelect').value;
      const parashaSelect = document.getElementById('parashaSelect');
      const parashot = Object.keys(aliyotMap).filter(p => {
        const firstRange = Object.values(aliyotMap[p])[0];
        return firstRange.startsWith(sefer);
      });

      parashaSelect.innerHTML = parashot.map(p => `<option>${p.split(',')[0]}</option>`).join('');
      if (preferredParasha && parashot.includes(preferredParasha)) {
        parashaSelect.value = preferredParasha;
      }

      parashaSelect.addEventListener('change', () => {
        populateAliyahDropdown();
        displayAliyahText()
      });
      populateAliyahDropdown();
    }

    function populateAliyahDropdown() {
      const parasha = document.getElementById("parashaSelect").value;
      const aliyahSelect = document.getElementById("aliyahSelect");
      const aliyot = aliyotMap[parasha] || {};

      aliyahSelect.innerHTML = Object.keys(aliyot)
        .map(a => `<option value="${a}">${a}</option>`)
        .join("");

      aliyahSelect.addEventListener("change", () => {
        saveProgress(parasha, aliyahSelect.value);
        displayAliyahText();
      });

      // console.log("RUN 3");
      // displayAliyahText();
    }

    document.getElementById("parashaSelect").addEventListener("change", () => {
      saveProgress(document.getElementById("parashaSelect").value, "Aliyah 1");
    });

    function toCamelCase(str) {
      str = str.toLowerCase();
      return str.toLowerCase().split(' ').map((word, i) => i === 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
    }

    function countChars(text) {
      return text.replace(/\s+/g, ' ') // normalize whitespace
        .trim()
        .length;
    }

    function estimateEnglishFlex(heText, enText) {
      const heChars = countChars(heText);
      const enChars = countChars(enText);
      
      const hebrewDensity = 1.0;
      const englishDensity = 0.72;
      
      const fontRatio = 1.4 / 1.1;

      const heScore = heChars * hebrewDensity;
      const enScore = enChars * englishDensity * fontRatio;

      return enScore / heScore;
    }

    async function displayAliyahText() {
      const parasha = document.getElementById('parashaSelect').value;
      const aliyah = document.getElementById('aliyahSelect').value;
      if (!aliyotMap[parasha] || !aliyotMap[parasha][aliyah]) return;
      
      const range = aliyotMap[parasha][aliyah];
      const rangeForApi = range.replace(/\s+/g, '.').replaceAll(':', '.').replace('-', '-');
      
      const apiUrl = `https://www.sefaria.org/api/texts/${rangeForApi}?context=0`;
      const rashiURL = `https://www.sefaria.org/api/texts/Rashi_on_${rangeForApi}?context=0`;
      const onkURL = `https://www.sefaria.org/api/texts/Onkelos_${rangeForApi}?context=0`.replace("Bereshit", "Genesis").replace("Shemot", "Exodus").replace("Vayikra", "Leviticus").replace("Bamidbar", "Numbers").replace("Devarim", "Deuteronomy");

      try {

        const [data, rashiData, onkData] = await Promise.all([
          fetch(apiUrl).then(res => res.json()),
          fetch(rashiURL).then(res => res.json()),
          fetch(onkURL).then(res => res.json())
        ]);

        let verseHtml = (data.he || []);
        let verseHTMLRashi = (rashiData.he || []);
        let verseHTMLRashiEng = (rashiData.text || []);
        let verseHTMLOnk = (onkData.he || []);

        if (!Array.isArray(verseHtml[0])) {
          verseHtml = [verseHtml];
          verseHTMLRashi = [verseHTMLRashi];
          verseHTMLRashiEng = [verseHTMLRashiEng];
          verseHTMLOnk = [verseHTMLOnk];
        }

        document.getElementById('textDisplay').innerHTML = `<div style="text-align: center;"><b>${parasha} ${aliyah}</b></div>`;
        let verseNumber = range.split('-')[0].split(':')[1];

        let chapters = []
        for (let i = rangeForApi.replace("-", ".").split(".")[1]; i <= rangeForApi.replace("-", ".").split(".")[3]; i++) { 
          chapters.push(i); // if the range is e.g. chapters 28 and 29, then you'll get chapters = [28, 29]
        }

        for (let i = 0; i < verseHtml.length; i++) {

          const chapterDiv = document.createElement('div');
          chapterDiv.style.cssText = `text-align: right; margin-right: 0.5rem; font-size: 2.0rem;`;
          chapterDiv.innerText = `×¤×¨×§ ${gematria(chapters[i])}`;
          document.getElementById('textDisplay').appendChild(chapterDiv);

          for (let j = 0; j < verseHtml[i].length; j++) {

            let line = verseHtml[i][j];
            let rashiLine = "";
            let rashiLineEng = "";
            try {
              rashiLine = verseHTMLRashi[i][j].join(' ');
              rashiLineEng = verseHTMLRashiEng[i][j];

            } catch (typeError) {
              let rashiLine = "";
              let rashiLineEng = "";
            }
            let onkLine = verseHTMLOnk[i][j];
            
            line = line
              .replaceAll(/<span[^>]*>\{×¤\}<\/span>/g, "{×¤}") // removes <span>{×¤}</span>, and replaces it with {×¤}
              // .replaceAll(/<span[^>]*>.*?<\/span>/g, "")
              .replaceAll(/&nbsp;/g, " ")
              .replaceAll(/\*\([^)]*\)/g, "")
              .replaceAll(/\s*\(\s*\)\s*/g, "")
              .replaceAll(/<sup[^>]*class=["']footnote-marker["'][^>]*>.*?<\/sup>\s*<i[^>]*class=["']footnote["'][^>]*>.*?<\/i>/g, "")
              .replaceAll(/<i[^>]*class=["']footnote["'][^>]*>.*?<\/i>/g, "")
              .replaceAll(/&nbsp;/g, " ")
              .replaceAll(/\*\([^)]*\)/g, "")
              .replaceAll(/\s*\(\s*\)\s*/g, "")
              .replaceAll(",", " ")
              .replaceAll("<br>", "")
              .replaceAll(" {×¤}", `&nbsp;<span style="color: darkgrey; font-size:1.0rem; vertical-align: 0.15em;">{×¤}</span><br>`) // removes {×¤}, and replaces it with \t\t
              .trim();

            for (let el of rashiLine) {
              el.replaceAll(`:,`, `: `);
            }

            if (line.trim() == '<br>') continue;
            if (line.trim() == '' ) continue;

            onkLine = onkLine.replaceAll("<b>", "").replaceAll("</b>", "");
            
            const span = document.createElement("span");
            span.style.display = "block";
            span.style.height = "auto";
            span.style.marginBottom = "0.5rem";
            span.style.marginTop = "0.5rem";

            span.innerHTML = `<small style="display: inline-block; margin:0 0.5rem; font-size:0.8rem; 
            vertical-align: 0.2em">${gematria(verseNumber)}</small>&nbsp;${line} `;
            span.innerHTML += `<span style="color: #2b6cb0">${line}</span> `
            span.innerHTML += `<span style="color: #2f855a">${onkLine}</span> `
            // span.innerHTML += ` <span style="color: skyblue">${line}</span>`;
            document.getElementById('textDisplay').appendChild(span);

            // === RASHI ===
            if (rashiLine != "") {

              const rashiContainer = document.createElement("div");
              rashiContainer.classList.add("rashi-container");

              // === Header (TOP BAR) ===
              const header = document.createElement("div");
              header.classList.add("rashi-header");

              // Controls group
              const controls = document.createElement("div");
              controls.classList.add("rashi-controls");

              // Arrow
              const arrow = document.createElement("span");
              arrow.classList.add("rashi-arrow");
              arrow.textContent = "â–¶";

              // Collapse All
              const collapseAllBtn = document.createElement("button");
              collapseAllBtn.textContent = "Collapse all";
              collapseAllBtn.classList.add("rashi-action-btn");
              collapseAllBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                collapseAllRashi();
              });

              // Expand All
              const expandAllBtn = document.createElement("button");
              expandAllBtn.textContent = "Expand all";
              expandAllBtn.classList.add("rashi-action-btn");
              expandAllBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                expandAllRashi();
              });

              // Label
              const label = document.createElement("span");
              label.textContent = "×¨×©\"×™";

              // --- assemble ---
              controls.appendChild(collapseAllBtn);
              controls.appendChild(expandAllBtn);
              controls.appendChild(arrow);

              header.appendChild(label);
              header.appendChild(controls);


              // === Collapsible BODY ===
              const body = document.createElement("div");
              body.classList.add("rashi-body", "collapsed");   // collapsed by default

              // Hebrew
              const span_rashi = document.createElement("div");
              span_rashi.classList.add("rashi-he");
              span_rashi.innerHTML = rashiLine;

              // English
              const span_rashi_eng = document.createElement("div");
              span_rashi_eng.classList.add("rashi-en");

              // Process English commentary
              rashiLineEng = rashiLineEng.map(line => {
                const parts = line.split('â€”');
                const title = toCamelCase(parts[0].trim());
                const commentary = parts[1] ? parts.slice(1).join('â€”').trim() : '';
                return `<b>${title}</b>${commentary ? ' â€” ' + commentary : ''}`;
              });

              span_rashi_eng.innerHTML = rashiLineEng.join('<br>');

              // Put Hebrew + English in the body
              body.appendChild(span_rashi);
              body.appendChild(span_rashi_eng);

              // Assemble
              rashiContainer.appendChild(header);
              rashiContainer.appendChild(body);
              document.getElementById('textDisplay').appendChild(rashiContainer);

              const ratio = estimateEnglishFlex(span_rashi.innerText, span_rashi_eng.innerText);
              span_rashi_eng.style.flex = Math.min(Math.max(ratio, 1.4), 2.6);

              // Toggle on header click
              header.addEventListener("click", () => {
                body.classList.toggle("collapsed");
                arrow.classList.toggle("rotated");
              });

            } else {
              document.getElementById('textDisplay').appendChild(document.createElement("br"));
            }
            // RASHI END

            verseNumber++;
            }
          verseNumber = 1;
          }
      } catch (err) {
        console.error('Error fetching text:', err);
        document.getElementById('textDisplay').innerText = 'Error loading text.';
      }
    }

    function expandAllRashi() {
      document.querySelectorAll(".rashi-body").forEach(b => b.classList.remove("collapsed"));
      document.querySelectorAll(".rashi-arrow").forEach(a => a.classList.add("rotated"));
    }

    function collapseAllRashi() {
      document.querySelectorAll(".rashi-body").forEach(b => b.classList.add("collapsed"));
      document.querySelectorAll(".rashi-arrow").forEach(a => a.classList.remove("rotated"));
    }

    function copyText(button) {
      const text = document.getElementById('textDisplay').innerText;
      navigator.clipboard.writeText(text);
      const icon = button.querySelector('.copy-icon');
      icon.textContent = 'âœ…';
      button.disabled = true;
      setTimeout(() => {
        icon.textContent = 'ðŸ“‹';
        button.disabled = false;
      }, 1500);
    }

    loadData();

    function gematria(num) {
      // Handle edge cases
      if (num < 1 || num > 999) {
        return "Number out of range";
      }

      const hundreds = ["", "×§", "×¨", "×©", "×ª"];
      const tens = ["", "×™", "×›", "×œ", "×ž", "× ", "×¡", "×¢", "×¤", "×¦"];
      const ones = ["", "×", "×‘", "×’", "×“", "×”", "×•", "×–", "×—", "×˜"];
      
      let result = "";

      // Handle hundreds
      const hundredValue = Math.floor(num / 100);
      result += hundreds[hundredValue];
      num %= 100;

      // Handle tens and ones
      // Special case for 15 (×™×”) and 16 (×™×•)
      if (num === 15) {
        result += "×˜×•";
      } else if (num === 16) {
        result += "×˜×–";
      } else {
        const tenValue = Math.floor(num / 10);
        result += tens[tenValue];
        num %= 10;
        result += ones[num];
      }

      // // Add the punctuation mark (gershayim) for numbers > 1
      // if (result.length > 1) {
      //   // Insert gershayim before the last letter
      //   result = result.slice(0, -1) + '×´' + result.slice(-1);
      // } else if (result.length === 1) {
      //   // Add geresh for single-letter numbers
      //   result += '×³';
      // }

      return result;
    }
  </script>
</body>
</html>
